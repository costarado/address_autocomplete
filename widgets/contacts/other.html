<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>Find Other Address</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
    }
    input {
      width: 100%;
      padding: 6px;
      margin-bottom: 8px;
      box-sizing: border-box;
    }
    button {
      padding: 8px 12px;
    }
  </style>

  <!-- Google Maps Places API -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDAL5Dl_ZM0vyNkrn1fFw3b6Jhzek_MZxU&libraries=places&language=he"
    async
    defer
  ></script>
</head>

<body>
  <h3>Find Other Address</h3>

  <input id="search" placeholder="Search address (Google)" />
  <input id="street" placeholder="Street" />
  <input id="house" placeholder="House" />
  <input id="city" placeholder="City" />
  <input id="zip" placeholder="Zip" />

  <button id="save">Save to Zoho</button>

  <script>
    console.log("Other address widget loaded");

    let autocomplete;

    function initAutocomplete() {
      if (!window.google || !google.maps || !google.maps.places) {
        console.error("Google Maps API not loaded");
        return;
      }

      const input = document.getElementById("search");

      autocomplete = new google.maps.places.Autocomplete(input, {
        types: ["address"],
        componentRestrictions: { country: "il" }
      });

      autocomplete.addListener("place_changed", onPlaceChanged);
      console.log("Google Autocomplete initialized");
    }

    function onPlaceChanged() {
      const place = autocomplete.getPlace();
      if (!place || !place.address_components) {
        return;
      }

      let street = "";
      let house = "";
      let city = "";
      let zip = "";

      place.address_components.forEach(c => {
        if (c.types.includes("route")) street = c.long_name;
        if (c.types.includes("street_number")) house = c.long_name;
        if (c.types.includes("locality")) city = c.long_name;
        if (c.types.includes("postal_code")) zip = c.long_name;
      });

      document.getElementById("street").value = street;
      document.getElementById("house").value = house;
      document.getElementById("city").value = city;
      document.getElementById("zip").value = zip;
    }

    // ждём загрузку Google
    window.addEventListener("load", () => {
      const check = setInterval(() => {
        if (window.google && google.maps && google.maps.places) {
          clearInterval(check);
          initAutocomplete();
        }
      }, 100);
    });

    // отправка в Zoho
    document.getElementById("save").addEventListener("click", () => {
      const payload = {
        type: "naymark_other",
        payload: {
          street: document.getElementById("street").value,
          house: document.getElementById("house").value,
          city: document.getElementById("city").value,
          zip: document.getElementById("zip").value
        }
      };

      window.parent.postMessage(payload, "*");
      console.log("Message sent to Zoho:", payload);
    });
  </script>
</body>
</html>
